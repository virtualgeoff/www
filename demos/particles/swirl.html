<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Swirl</title>
	<meta name="description" content="a cloud of particles in motion.">
	<meta name="keywords" content="particles, orbit">
	<meta name="author" content="virtualgeoff">
	<meta name="created" content="2022-12-03">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<style>

		html, body {margin:0; padding:0;}
		body {width:100vw; height:100vh; font-family:sans-serif; color:#090; background:#000; overflow:hidden;}
		#canvas {display:block;}

		body > p {position:absolute; top:0; width:20vw; margin:0; padding:1em; color:#0c0; z-index:99;}
		#info1 {left:0;    text-align:left;}
		#info2 {left:40vw; text-align:center;}
		#info3 {right:0;   text-align:right;}

	</style>
	<script>

		/* jshint esversion: 6 */

		function particles() {
			// a cloud of particles orbiting the center of the window
			let canvas, ctx, origin = {}, radius, W, H;
			let info1, info2, info3;
			let previousTimeStamp, deltaT;

			const points = [];
			const N = 200; // number of points
			const GM = 500;
			const tau = 2 * Math.PI;

			function init() {
				// info
				info1 = document.querySelector('#info1');
				info2 = document.querySelector('#info2');
				info3 = document.querySelector('#info3');

				// get canvas element
				canvas = document.querySelector('canvas');
				ctx = canvas.getContext('2d');
				setSize();

				// start with non-zero number of points
				//for (let i=0; i<N/20; i++) {
					//points.push( makePoint() );
				//}
			}

			function makePoint() {
				let point, r, v, θ;
				r = 20 + Math.random() * 10; // random position
				θ = Math.random() * tau;
				v = Math.sqrt(GM / r); // v = √(GM/r) for ~circular orbit
				v *= (1.15 + Math.random() * 0.2); // ±10%

				point = {
					x: r * Math.cos(θ),
					y: -H/2,
					z: r * Math.sin(θ),
					vx: -v * Math.sin(θ), // make velocity ⟂ to r
					vy: 5 + Math.random() * 2,
					vz: v * Math.cos(θ),
					ax: 0,
					ay: 0,
					az: 0,
					r: Math.round(Math.random() * 5) + 1,
					c: `hsl(${(Math.random()*360)} 100% 50%)` // random color
					//c: `hsl(${r/radius*280} 100% 50%)` // color according to distance
				};
				return point;
			}

			function setSize() {
				// get canvas size and origin
				canvas.width = W = window.innerWidth;
				canvas.height = H = window.innerHeight;
				origin.x = W/2;
				origin.y = H/2;
				radius  = Math.max(canvas.width, canvas.height) / 2;
				info3.innerText = `${W} × ${H} px`;
			}

			function draw(timestamp) {
				let p, r, f, d;
				ctx.clearRect(0, 0, canvas.width, canvas.height);

				// create some new points each loop (and/or retire some old ones)
				for (let i=0; i<1; i++) {
					if (points.length >= N) {
						points.shift();
					}
					points.push( makePoint() );
				}

				// draw all the points
				for (let i=0; i<points.length; i++) {
					p = points[i];
					// calculate force
					r = Math.sqrt(p.x * p.x + p.z * p.z);
					f = GM / (r * r); // f = GmM/r^2
					// calculate acceleration, velocity, position
					p.ax = -p.x/r * f;
					p.ay = 0;//-0.02;
					p.az = -p.z/r * f;
					p.vx += p.ax;
					//p.vy += p.ay;
					p.vy *= 0.995;
					p.vz += p.az;
					p.x += p.vx;
					p.y += p.vy;
					p.z += p.vz;

					// if a point goes out of frame, remove it and make a new one
					if (p.y > H/2) {
						points.splice(i, 1);
						//points.push( makePoint() );
					}

					// change color based on z-distance
					d = -60 + p.z * 1;
					if (d > 15) { d = 15; }
					if (d < -135) { d = -135; }
					p.c = `hsl(${d} 100% 50% / 0.7)`;

					// draw the point
					ctx.fillStyle = p.c;
					ctx.beginPath();
					ctx.ellipse(origin.x + p.x, origin.y - p.y, p.r, p.r, 0, 0, tau);
					ctx.fill();
				}

				// update data
				if (previousTimeStamp) {
					deltaT = timestamp - previousTimeStamp;
					info1.innerText = `n: ${points.length}\nΔt: ${deltaT} ms`;
				}
				previousTimeStamp = timestamp;

				// repeat
				requestAnimationFrame(draw);
			}

			init();
			draw();
			window.addEventListener('resize', setSize);
		}

		document.addEventListener('DOMContentLoaded', particles);

	</script>
</head>
<body>

	<canvas></canvas>

	<p id="info1">data</p>
	<p id="info2"></p>
	<p id="info3"></p>

</body>
</html>
